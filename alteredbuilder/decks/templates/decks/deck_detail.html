{% extends "base.html" %}

{% load static %}
{% load i18n %}
{% load deck_styles %}
{% load markdown_extras %}


{% block title %}{{ deck.name }}{% endblock %}
{% block meta_title %}{{ deck.name }} | {{ block.super }}{% endblock %}
{% block meta_image %}{% cdn_image_url deck.hero.image_url %}{% endblock %}


{% block head %}
    {{ block.super }}
    <!-- Script to render pie charts. I'd like to use Chart.js instead -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- utils script to display a toast -->
    <script src="{% static 'js/utils.js' %}"></script>
    <!-- Script to generate a QR code image, copy it into the clipboard and download it -->
    <script src="https://unpkg.com/@bitjson/qr-code@1.0.2/dist/qr-code.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://superal.github.io/canvas2image/canvas2image.js"></script>
    <!-- Base styles of this app -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <!-- Styles adding the fonts used to display the Altered icons -->
    <link rel="stylesheet" href="{% static 'css/altered-icons.css' %}">
    <!-- Scripts for this view -->
    <link rel="stylesheet" href="{% static 'css/deck-detail.css' %}">
{% endblock %}


{% block content %}
    <!-- Deck's name -->
    <h1 id="deckName">{{ deck.name }}</h1>
    <!-- Deck's description -->
    <div class="row">
        <div class="col">{{ deck.description | escape | markdown | safe }}</div>
    </div>
    <!-- Metadata row -->
    <div class="row row-cols-auto">
        <!-- Creator's details -->
        <div class="col" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title='{% include 'profiles/tooltips/user_profile.html' %}' data-bs-html="true">
            {% if deck.is_followed %}<i class="fa-solid fa-star"></i>{% else %}<i class="fa-regular fa-star"></i>{% endif %} <a href="{{ deck.owner.profile.get_absolute_url }}" class="link-opacity-50-hover link-offset-3"><i class="fa-solid fa-user"></i> {{ deck.owner.username|safe_username }}</a>
        </div>
    </div>
    <div class="row row-cols-auto mb-2">
        <div class="d-flex justify-content-between align-items-center w-100 flex-wrap">
            <div class="d-flex justify-content-start align-items-center user-select-none">
                <!-- Creation and modification times -->
                <div class="me-3" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="{% include 'decks/tooltips/deck_timestamps.html' %}" data-bs-html="true">
                    <i class="fa-regular fa-calendar"></i> <small>{{ deck.modified_at|date:"SHORT_DATE_FORMAT" }}</small>
                </div>
                <div class="me-3">
                    <span class="shadowed"><i class="fa-solid fa-eye"></i> {{ deck.hit_count_generic.first.hits }}</span>
                </div>
                <div class="me-3">
    {% if user.is_authenticated %}
                    <!-- Love count and button -->
                    <a type="button" class="btn {% if not deck.is_loved %}btn-outline{% endif %} altered-style btn-sm" href="{% url 'love-deck-id' pk=deck.id %}">
                        <i class="fa-solid fa-heart"></i> {{ deck.love_count }}
                    </a>
    {% else %}
                    <div data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="{% translate 'Login to share your love!' %}" data-bs-html="true">
                        <a type="button" class="btn btn-outline altered-style btn-sm" href="{% url 'love-deck-id' pk=deck.id %}">
                            <i class="fa-solid fa-heart"></i> {{ deck.love_count }}
                        </a>
                    </div>
    {% endif %}
                </div>
                <!-- Comment count and button -->
                <div class="me-3">
                    <a type="button" class="btn {% if deck.comment_count == 0 %}btn-outline{% endif %} altered-style btn-sm" style="cursor: pointer;" data-bs-toggle="offcanvas" data-bs-target="#commentsOffcanvas" aria-controls="commentsOffcanvas">
                        <i class="fa-solid fa-comment"></i> {{ deck.comment_count }}
                    </a>
                </div>
    {% if deck.owner == user %}
                <div class="me-3">
                    <!-- Edit Deck button-->
                    <a type="button" class="btn altered-style btn-sm" href="{% url 'cards' %}?deck={{ deck.id }}{% if deck.hero %}&faction={{ deck.hero.faction }}{% endif %}">
                        <i class="fa-solid fa-wrench"></i> {% translate "Edit deck" %}
                    </a>
                </div>
    {% endif %}
    {% if deck.owner == user %}
                <!-- Options dropdown -->
                <div class="btn-group me-2" role="group">
                    <button type="button" class="btn altered-style btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa-solid fa-gears"></i> {% translate "Options" %}
                    </button>
                    <ul class="dropdown-menu">
                        <li id="edit-deck-tags"><a class="dropdown-item edit-deck-tags-trigger" href="#" data-bs-toggle="modal" data-bs-target="#deck-tags-modal"><i class="fa-solid fa-tags"></i> {% translate "Edit tags" %}</a></li>
                        <li id="edit-deck-metadata"><a class="dropdown-item edit-deck-metadata-trigger" href="#" data-bs-toggle="modal" data-bs-target="#deck-metadata-modal"><i class="fa-solid fa-pen"></i> {% translate "Edit metadata" %}</a></li>
                        <li id="delete-deck"><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#delete-deck-modal"><i class="fa-solid fa-trash"></i> {% translate "Delete deck" %}</a></li>
                    </ul>
                </div>
    {% endif %}
                <!-- Deck tags -->
                <div class="d-flex align-items-center">

    {% for tag in deck.tags.all %}
        {% if tag.type == "TY" %}
                    <span class="badge bg-primary me-2">{{ tag.name }}</span>
        {% else %}
                    <span class="badge bg-secondary me-2">{{ tag.name }}</span>
        {% endif %}
    {% endfor %}

                </div>
            </div>

            <div class="d-flex justify-items-center">
                <div class="input-group mb-3">
                    <button class="btn display-selector" type="button" id="changeToCardDisplay"><i class="fa-solid fa-table-cells"></i></button>
                    <button class="btn display-selector" type="button" id="changeToTableDisplay"><i class="fa-solid fa-list"></i></button>
                  </div>
            </div>
            <div class="d-flex justify-items-end">
                <!-- Goldfishing access -->
    {% if stats.rarity_distribution.unique %}
                <div class="ms-2" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="{% translate 'This feature cannot be used with unique cards' %}">
                    <button type="button" class="btn btn-outline-primary btn-sm" disabled>
                        <i class="fa-solid fa-gamepad"></i> <i class="fa-solid fa-arrow-up-right-from-square"></i>
                    </button>
                </div>
    {% else %}
                <div class="ms-2" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="{% translate 'Try it in Exalts Table' %}">
                    <a type="button" class="btn btn-outline-primary btn-sm" href="https://exalts-table.com/deck-test/link/?decklist={{ decklist|urlencode }}" target="_blank">
                        <i class="fa-solid fa-gamepad"></i> <i class="fa-solid fa-arrow-up-right-from-square"></i>
                    </a>
                </div>
    {% endif %}
                <!-- View button -->
                <div class="ms-2">
    {% if deck.hero %}
                    <div data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="{% translate 'By Taum' %}">
                        <a id="deckShowcaseButton" role="button" class="btn btn-sm btn-outline-warning">
                            <i class="fa-solid fa-eye"></i> <i class="fa-solid fa-arrow-up-right-from-square"></i>
                        </a>
                    </div>
    {% else %}
                    <div data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="{% translate 'The deck needs a hero!' %}">
                        <a role="button" class="btn btn-sm btn-outline-warning disabled">
                            <i class="fa-solid fa-eye"></i> <i class="fa-solid fa-arrow-up-right-from-square"></i>
                        </a>
                    </div>
    {% endif %}
                </div>
                <div class="ms-2">
                    <!-- Copy Deck button-->
                    <a type="button" class="btn btn-outline-primary btn-sm" href="{% url 'new-deck' %}?decklist={{ decklist|urlencode }}">
                        <i class="fa-solid fa-copy"></i>
                    </a>
                </div>
                <div class="ms-2">
                    <!-- Share dropdown -->
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa-solid fa-share-nodes"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li id="copy-self-link"><a class="dropdown-item" href="#"><i class="fa-regular fa-copy"></i> {% translate "Copy link" %}</a></li>
                            <li id="copy-decklist"><a class="dropdown-item" href="#"><i class="fa-regular fa-copy"></i> {% translate "Copy decklist" %}</a></li>
    {% if deck.is_public %}
                            <li id="share-qr-code"><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#qr-code-modal"><i class="fa-solid fa-qrcode"></i> {% translate "QR Code" %}</a></li>
                            <li id="share-facebook"><a class="dropdown-item" href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank"><i class="fa-brands fa-facebook"></i> Facebook</a></li>
                            <li id="share-telegram"><a class="dropdown-item" href="https://telegram.me/share/url?url={{ request.build_absolute_uri }}" target="_blank"><i class="fa-brands fa-telegram"></i> Telegram</a></li>
                            <li id="share-twitter"><a class="dropdown-item" href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}" target="_blank"><i class="fa-brands fa-twitter"></i> Twitter</a></li>
                            <li id="share-whatsapp"><a class="dropdown-item" href="https://wa.me/?text={{ request.build_absolute_uri }}" target="_blank"><i class="fa-brands fa-whatsapp"></i> Whatsapp</a></li>
    {% elif deck.owner == user %}
                            <li id="create-private-link"><a class="dropdown-item" href="#"><i class="fa-solid fa-link"></i> {% translate "Create private link" %}</a></li>
    {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12 col-sm-6 col-lg-4 col-xl-3 sticky-column d-flex justify-content-center">
            <!-- Card display -->
            <!-- It will show the first image available in this order: hero, characters, spells, permanents -->
            {% firstof deck.hero.image_url character_list.0.1.image_url spell_list.0.1.image_url permanent_list.0.1.image_url "" as display_image %}
            <img class="img-fluid rounded-4" id="card-showcase" src="{% cdn_image_url display_image %}">
        </div>

        <div class="col card-display-view d-none">

    {% if deck.hero %}
            <div class="row">
                <h3 class="mb-0">{% translate "Hero" %}</h3>
                <hr class="altered-style mt-0"/>
                <div class="col-xxl-2 col-xl-3 col-md-4 col-sm-6 mb-3">
                    <div class="card-display rounded-3 card-hover" data-rarity="{{ deck.hero.get_rarity_display }}" data-image-url="{% cdn_image_url deck.hero.image_url %}" data-faction="{{ deck.hero.faction }}">
                        <img src="{% cdn_image_url deck.hero.image_url %}" class="card-img-top rounded-3" alt="{{ deck.hero.name }}">
                    </div>

                    <div class="d-flex justify-content-end text-end mt-1">
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="--bs-btn-padding-y: .01rem;"></button>
                            <ul class="dropdown-menu altered-style">
                                <li><a class="dropdown-item" href="{{ deck.hero.get_official_link }}" target="_blank" rel="noopener noreferrer"><i class="fa-solid fa-arrow-up-right-from-square"></i> {% translate "Go to details" %}</a></li>
                                <li><a class="dropdown-item card-reference-container" href="#" data-card-reference="{{ deck.hero.reference }}"><i class="fa-regular fa-copy"></i> {% translate "Copy card reference" %}</a></li>
        {% if deck.owner == user %}
                                <li><a class="dropdown-item remove-card-trigger" href="#" data-card-reference="{{ deck.hero.reference }}"><i class="fa-solid fa-trash"></i> {% translate "Remove card" %}</a></li>
        {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
    {% endif %}

    {% if character_list %}
            <!-- Card table of characters -->
            {% translate "Spells" noop as _ %}
            {% include "decks/snippets/card_list.html" with type="Characters" card_list=character_list %}
    {% endif %}

    {% if spell_list %}
            <!-- Card table of spells -->
            {% translate "Spells" noop as _ %}
            {% include "decks/snippets/card_list.html" with type="Spells" card_list=spell_list %}
    {% endif %}

    {% if permanent_list %}
            <!-- Card table of permanents -->
            {% translate "Permanents" noop as _ %}
            {% include "decks/snippets/card_list.html" with type="Permanents" card_list=permanent_list %}
    {% endif %}

        </div>
        <div class="card-table-view d-none col-lg-4 col-sm-6 col-12 mt-sm-0 mt-4">
            <!-- Hero table -->
            <p><i class="fa-solid fa-person-hiking"></i> {% translate "Hero" %}</p>
            <table class="table table-striped table-hover card-table" id="hero-table" aria-describedby="Deck hero">
                <thead>
                    <tr>
                        <!-- Show name and faction -->
                        <th scope="col">{% translate "Name" %}</th>
                        <th scope="col">{% translate "Faction" %}</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody class="table-group-divider">
    {% if deck.hero %}
                    <tr class="table-light card-hover" data-image-url="{% cdn_image_url deck.hero.image_url %}">
                        <!-- Hero name -->
                        <td class="user-select-all">{{ deck.hero.name }}</td>
                        <!-- Hero faction -->
                        <td>{% include "decks/snippets/picture_webp.html" with img_name=deck.hero.faction width=20 height=20 %} {{ deck.hero.get_faction_display|title }}</td>
                        <!-- Hero options -->
                        <td class="text-end pe-3" style="width: 1%;">
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="--bs-btn-padding-y: .01rem;"></button>
                                <ul class="dropdown-menu altered-style">
                                    <li><a class="dropdown-item" href="{{ deck.hero.get_official_link }}" target="_blank" rel="noopener noreferrer"><i class="fa-solid fa-arrow-up-right-from-square"></i> {% translate "Go to details" %}</a></li>
                                    <li><a class="dropdown-item card-reference-container" href="#" data-card-reference="{{ deck.hero.reference }}"><i class="fa-regular fa-copy"></i> {% translate "Copy card reference" %}</a></li>
        {% if deck.owner == user %}
                                    <li><a class="dropdown-item remove-card-trigger" href="#" data-card-reference="{{ deck.hero.reference }}"><i class="fa-solid fa-trash"></i> {% translate "Remove card" %}</a></li>
        {% endif %}
                                </ul>
                            </div>
                        </td>
                    </tr>
    {% else %}
                    <tr><td colspan="2" class="text-center">{% translate "No hero" %}</td></tr>
    {% endif %}
                </tbody>
            </table>

    {% if spell_list %}
            <!-- Card table of spells -->
            <p class="mt-4"><i class="fa-solid fa-hat-wizard"></i> {% translate "Spells" %}</p>
            {% include "decks/snippets/card_table.html" with type="spell" card_list=spell_list %}
    {% endif %}

    {% if permanent_list %}
            <!-- Card table of permanents -->
            <p class="mt-4"><i class="fa-solid fa-landmark"></i> {% translate "Permanents" %}</p>
            {% include "decks/snippets/card_table.html" with type="permanent" card_list=permanent_list %}
    {% endif %}

        </div>

        <div class="card-table-view d-none col-lg-4 col-sm-6 col-12 offset-sm-6 offset-lg-0 mt-lg-0 mt-4">
            <!-- Card table of characters -->
            <p><i class="fa-solid fa-people-group"></i> {% translate "Characters" %}</p>
            {% include "decks/snippets/card_table.html" with type="character" card_list=character_list %}
        </div>
    </div>


    <div class="row mt-4">
        <!-- Stats row -->
        <div>
            <h3>{% translate "Stats" %}</h3>
            <hr class="altered-style mt-0"/>
        </div>
        <!-- Pie chart -->
        <div class="col-12 col-xl-4 col-md-6">
            <h5>{% translate "Card Type Distribution" %}</h5>
            <div id="distribution-pie-chart" class="my-4"></div>
        </div>
        <!-- Table stats -->
        <div class="col-12 col-xl-4 col-md-6 mb-5 mb-md-0">
            <!-- Rarity distribution -->
            <h5>{% translate "Rarity distribution" %}</h5>
            <table class="table table-striped table-sm mb-5" aria-describedby="Rarity distribution">
                <thead>
                    <tr>
                        <th scope="col">{% translate "Rarity" %}</th>
                        <th scope="col">{% translate "Count" %}</th>
                    </tr>
                </thead>
                <tbody class="table-group-divider">
                    <tr>
                        <td>{% translate "Common" %}</td>
                        <td>{{ stats.rarity_distribution.common }}</td>
                    </tr>
                    <tr>
                        <td>{% translate "Rare" %}</td>
                        <td>{{ stats.rarity_distribution.rare }}</td>
                    </tr>
                    <tr>
                        <td>{% translate "Unique" %}</td>
                        <td>{{ stats.rarity_distribution.unique }}</td>
                    </tr>
                </tbody>
            </table>
            <!-- Probability of drawing cards -->
            <h5>{% translate "Probability of drawing" %}</h5>
            <table class="table table-striped table-sm mb-5" id="probability-table" aria-describedby="Probability to draw">
                <thead>
                    <tr>
                        <th scope="col">{% translate "Type" %}</th>
                        <th scope="col">{% translate "Anytime" %}</th>
                        <th scope="col">{% translate "Initial hand" %}</th>
                    </tr>
                </thead>
                <tbody class="table-group-divider">
                    <tr>
                        <td>{% translate "Characters" %}</td>
                        <td id="characters-anytime-draw"></td>
                        <td id="characters-initial-draw"></td>
                    </tr>
                    <tr>
                        <td>{% translate "Spells" %}</td>
                        <td id="spells-anytime-draw"></td>
                        <td id="spells-initial-draw"></td>
                    </tr>
                    <tr>
                        <td>{% translate "Permanents" %}</td>
                        <td id="permanents-anytime-draw"></td>
                        <td id="permanents-initial-draw"></td>
                    </tr>
                </tbody>
            </table>
            <!-- Deck's legality on different formats -->
            <h5>{% translate "Format legality" %}</h5>
            <table class="table table-striped table-sm" id="probability-table" aria-describedby="Probability to draw">
                <thead>
                    <tr>
                        <th scope="col">{% translate "Format" %}</th>
                        <th scope="col">{% translate "Is it legal?" %}</th>
                        <th scope="col">{% translate "Notes" %}</th>
                    </tr>
                </thead>
                <tbody class="table-group-divider">
                    <tr>
                        <td>{% translate "Standard" %}</td>
    {% if deck.is_standard_legal %}
                        <td>{% translate "Yes" %}</td>
                        <td></td>
    {% else %}
                        <td>{% translate "No" %}</td>
                        <td>
        {% for error in legality.standard.errors %}
                            {{ error }}<br>
        {% endfor %}
                        </td>
    {% endif %}
                    </tr>
                    <tr>
                        <td>{% translate "ExAlts Championship" %}</td>
    {% if deck.is_exalts_legal %}
                        <td>{% translate "Yes" %}</td>
                        <td></td>
    {% else %}
                        <td>{% translate "No" %}</td>
                        <td>{% translate "This mode works the same as Standard but replaces the 3 uniques with 3 extra rares." %}</td>
    {% endif %}
                    </tr>
                    <tr>
                        <td>{% translate "Draft" %}</td>
    {% if deck.is_draft_legal %}
                        <td>{% translate "Yes" %}</td>
                        <td></td>
    {% else %}
                        <td>{% translate "No" %}</td>
                        <td>
        {% for error in legality.draft.errors %}
                            {{ error }}<br>
        {% endfor %}
                        </td>
    {% endif %}
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="col-12 col-xl-4 col-md-8">
            <!-- Mana curve bar chart -->
            <h5>{% translate "Mana curve" %}</h5>
            <div id="mana-curve-chart" class="mt-4"></div>
        </div>
    </div>
    <!-- Simple toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="simple-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body d-flex">
                <span id="toast-text"></span>
                <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>
    
    {% if deck.owner == user %}
    <!-- Modal to edit the Deck's metadata -->
    <div class="modal fade" id="deck-metadata-modal" tabindex="-1" aria-labelledby="deck-metadata-modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="deck-metadata-modalLabel">{% translate "Edit metadata" %}</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'update-deck-metadata' pk=deck.id %}" method="post" id="update-deck-metadata-form">
                        {% csrf_token %}
                        {{ metadata_form }}
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% translate "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary" form="update-deck-metadata-form">{% translate "Apply" %}</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal to edit the Deck's tags -->
    <div class="modal fade" id="deck-tags-modal" tabindex="-1" aria-labelledby="deck-tags-modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="deck-tags-modalLabel">{% translate "Edit tags" %}</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'update-deck-tags' pk=deck.id %}" method="post" id="update-deck-tags-form">
                        {% csrf_token %}

                        <!-- Types Section -->
                        <div class="mb-3">
                            <h5 class="mb-0">{% translate "Playstyle" %}</h5>
                            <small>{% translate "Define the overall approach or strategy the deck follows" %}</small>
                            
        {% for tag in tags_form.primary_tags.field.queryset %}
                            <div class="form-check primary-tag-selector {% if forloop.first %}mt-3{% endif %}">
                                <input class="form-check-input" type="radio" name="{{ tags_form.primary_tags.name }}" id="{{ tags_form.primary_tags.auto_id }}_{{ tag.pk }}" value="{{ tag.pk }}" {% if tag.pk in tags_form.initial.tags %}checked{% endif %}>
                                <label class="form-check-label" for="{{ tags_form.primary_tags.auto_id }}_{{ tag.pk }}">
                                    {{ tag.name }}
                                    <small class="text-muted"> - {{ tag.description }}</small>
                                </label>
                            </div>
        {% endfor %}
                        </div>

                        <!-- Subtypes Section -->
                        <div class="mb-3">
                            <h5 class="mb-0">{% translate "Sub-strategy" %}</h5>
                            <small>{% translate "Highlight specific tactics or themes" %}</small>
        {% for tag in tags_form.secondary_tags.field.queryset %}
                            <div class="form-check secondary-tag-selector {% if forloop.first %}mt-3{% endif %}">
                                <input class="form-check-input" id="{{ tags_form.secondary_tags.auto_id }}_{{ tag.pk }}" type="checkbox" name="{{ tags_form.secondary_tags.name }}" value="{{ tag.pk }}" {% if tag.pk in tags_form.initial.tags %}checked{% endif %}>
                                <label class="form-check-label" for="{{ tags_form.secondary_tags.auto_id }}_{{ tag.pk }}">
                                    {{ tag.name }}
                                    <small class="text-muted"> - {{ tag.description }}</small>
                                </label>
                            </div>
        {% endfor %}
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% translate "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary" form="update-deck-tags-form">{% translate "Apply" %}</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal to confirm the deletion of the Deck -->
    <div class="modal fade" id="delete-deck-modal" tabindex="-1" aria-labelledby="delete-deck-modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="delete-deck-modalLabel">{% translate "Delete deck" %}</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% translate "Are you sure you want to delete this deck?" %}<br>{% translate "It won't be possible to recover it later." %}
                </div>
                <div class="modal-footer">
                    <a type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% translate "Close" %}</a>
                    <a type="button" class="btn btn-danger" href="{% url 'delete-deck-id' pk=deck.id %}">{% translate "Delete" %}</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% if deck.is_public %}
    <!-- Modal to show the Deck's QR code -->
    <div class="modal fade" id="qr-code-modal" tabindex="-1" aria-labelledby="qr-code-modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="qr-code-modalLabel">{% translate "Deck QR Code" %}</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <qr-code id="deck-qr-code" contents="{{ request.build_absolute_uri }}" squares="true"></qr-code>
                </div>
                <div class="modal-footer">
                    <a type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% translate "Close" %}</a>
                    <a id="copy-qr-svg" type="button" class="btn btn-primary">{% translate "Copy" %}</a>
                    <a id="download-qr-svg" type="button" class="btn btn-primary">{% translate "Download" %}</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- Sidebar with the Deck's comments -->
    <div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="commentsOffcanvas" aria-labelledby="commentsOffcanvasLabel">
        
        <button class="btn btn-sm btn-secondary offcanvas-btn position-absolute mt-2 {% if deck.comment_count %}animate{% endif %}" type="button" data-bs-toggle="offcanvas" data-bs-target="#commentsOffcanvas">
            <span>{% blocktranslate count comment_count=deck.comment_count %}{{ comment_count }} comment{% plural %}{{ comment_count }} comments{% endblocktranslate%}</span>
        </button>
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="commentsOffcanvasLabel">{% translate "Comments" %}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <section class="content-item" id="comments">
                <div class="container">
                    <div class="col">
        {% if user.is_authenticated %}
                        <!-- Create a comment form -->
                        <form action="{% url 'create-deck-comment' pk=deck.id %}" method="post" id="create-deck-comment-form">
                            {% csrf_token %}
                            {{ comment_form }}
                        </form>
        {% else %}
                        <diV>
                            <p>{% translate "Login to use this feature!" %}<br>
                            <a role="button" class="btn active text-info-emphasis" href="{% url 'account_login' %}?next={{ request.path }}"><i class="fa-solid fa-user"></i> {% translate "Login" %}</a></p>
                        </div>
        {% endif %}
                        <!-- Display all comments -->
        {% for comment in comments %}
                        <div class="media comment-body">
                            <div class="media-body">
                                <h4 class="media-heading">
                                    <img src="{{ comment.user.profile.get_avatar_image }}" alt="{{ comment.user.username }}'s profile picture" class="user-profile-pic rounded-circle" width="50" height="50">
                                    <a href="{{ comment.user.profile.get_absolute_url }}">{{ comment.user.username|safe_username }}</a>
                                    <span class="float-end">
            {% if comment.user == request.user %}
                                        <!-- The writer of the Comment can delete it -->
                                        <a role="button" class="btn btn-sm btn-outline-danger delete-comment" href="{% url 'delete-comment' pk=deck.id comment_pk=comment.id %}">
                                            <i class="fa-solid fa-trash"></i> {% translate "Delete" %}
                                        </a>
            {% endif %}
                                    </span>
                                </h4>
                                <!-- Comment body -->
                                <p>{{ comment.body }}</p>
                                <ul class="list-unstyled list-inline media-detail">
                                    <!-- Vote Comment button -->
                                    <li class="list-inline-item float-end">
                                        <a role="button" class="btn btn-sm upvote-comment {% if comment.is_upvoted %}btn-primary{% else %}btn-outline-primary{% endif %} {% if not user.is_authenticated %}disabled{% endif %}" href="{% url 'vote-comment' pk=deck.id comment_pk=comment.id %}">
                                            <i class="fa-solid fa-thumbs-up"></i> <span class="comment-count">{{ comment.vote_count }}</span>
                                        </a>
                                    </li>
                                    <!-- Creation date -->
                                    <li class="list-inline-item">
                                        <i class="fa fa-calendar"></i> {% blocktranslate with time_since=comment.created_at|timesince %}{{ time_since }} ago{% endblocktranslate %}
                                    </li>
                                </ul>
                            </div>
                        </div>
        {% endfor %}
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Decklist data -->
    <article id="decklist-text" data-decklist="{{ decklist }}"></article>
    {% csrf_token %}
    <!-- Deck statistics to be picked up by JS -->
    {{ stats|json_script:"deck-stats" }}
{% endblock %}

{% block bodyscripts %}
    <!-- Import deckfmt module -->
    <script src="{% static 'js/altered-deckfmt.umd.cjs' %}"></script>
    <!-- Script to interact with the Deck -->
    <script src="{% static 'js/deck-detail.js' %}"></script>
    <!-- Script to display the Deck's stats -->
    <script src="{% static 'js/deck-stats.js' %}"></script>
    <!-- Enable tooltips -->
    <script src="{% static 'js/tooltip-enable.js' %}"></script>
{% endblock %}
